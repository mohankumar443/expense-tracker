<div class="min-h-screen bg-[#0f1729] transition-colors duration-300">
    <!-- Header -->
    <header
        [class]="'bg-[#1a2332] shadow-lg sticky top-0 z-40 border-b border-gray-700/50 transition-all duration-500 ' + (isSidebarCollapsed ? 'ml-20' : 'ml-72')">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 text-white">
                    <span class="material-icons text-4xl text-primary">account_balance_wallet</span>
                    <div>
                        <h1 class="text-3xl font-black leading-tight">
                            {{ activeProfile.name ? activeProfile.name + "'s " : "" }}Financial Modus
                        </h1>
                        <div class="flex flex-wrap items-center gap-2.5 mt-1.5">
                            <div class="flex items-center gap-1.5">
                                <span
                                    class="px-2 py-0.5 rounded-md bg-indigo-500/10 text-indigo-400 text-[10px] font-black uppercase tracking-[0.1em] border border-indigo-500/20 shadow-sm">Analyze</span>
                                <span
                                    class="px-2 py-0.5 rounded-md bg-rose-500/10 text-rose-400 text-[10px] font-black uppercase tracking-[0.1em] border border-rose-500/20 shadow-sm">Optimize</span>
                                <span
                                    class="px-2 py-0.5 rounded-md bg-emerald-500/10 text-emerald-400 text-[10px] font-black uppercase tracking-[0.1em] border border-emerald-500/20 shadow-sm">Build</span>
                                <span
                                    class="px-2 py-0.5 rounded-md bg-amber-500/10 text-amber-400 text-[10px] font-black uppercase tracking-[0.1em] border border-amber-500/20 shadow-sm">Freedom</span>
                            </div>
                            <div class="hidden sm:block h-3.5 w-[1.5px] bg-white/10 rounded-full mx-1"></div>
                            <div
                                class="flex items-center gap-2 px-3.5 py-1.5 rounded-full bg-gradient-to-r from-primary/10 to-purple-500/10 backdrop-blur-md border border-white/5 shadow-[inset_0_1px_1px_rgba(255,255,255,0.05)] group hover:border-primary/30 transition-all duration-300">
                                <div class="relative flex items-center justify-center">
                                    <div class="absolute inset-0 bg-primary/20 blur-sm rounded-full animate-pulse">
                                    </div>
                                    <span
                                        class="material-icons text-primary text-[14px] relative z-10">auto_graph</span>
                                </div>
                                <span class="text-[11px] text-gray-200/90 font-bold tracking-tight">
                                    {{ projectionLabel }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <button (click)="showProfileMenu = !showProfileMenu"
                        class="flex items-center space-x-2 px-4 py-2.5 rounded-xl bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border border-gray-200 dark:border-gray-600 hover:bg-white dark:hover:bg-gray-700 transition-all duration-300 shadow-lg">
                        <div
                            class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center shadow-md">
                            <span class="material-icons text-white text-lg">person</span>
                        </div>
                        <div class="text-left">
                            <p class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">
                                Analyze • Optimize • Build • Freedom</p>
                            <p class="text-sm font-bold text-gray-800 dark:text-gray-100 truncate">{{ activeProfile.name
                                || 'Set up' }}</p>
                        </div>
                        <span class="material-icons text-gray-600 dark:text-gray-300 text-sm"
                            [class.rotate-180]="showProfileMenu">expand_more</span>
                    </button>

                    <div *ngIf="showProfileMenu"
                        class="absolute right-0 mt-3 w-[28rem] bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden z-50">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <p class="text-xs font-semibold text-blue-500 uppercase tracking-wide mb-2">Profile</p>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" [(ngModel)]="activeProfile.name" placeholder="Name"
                                    class="w-full bg-gray-50 dark:bg-[#0f1729] border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <input type="date" [(ngModel)]="activeProfile.dob" (ngModelChange)="onDobChange($event)"
                                    class="w-full bg-gray-50 dark:bg-[#0f1729] border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <input type="number" [ngModel]="activeProfile.age" readonly
                                    class="w-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-900 dark:text-white">
                                <input type="number" [(ngModel)]="activeProfile.retirementAge"
                                    placeholder="Retirement Age"
                                    class="w-full bg-gray-50 dark:bg-[#0f1729] border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <select [(ngModel)]="activeProfile.id" (ngModelChange)="setActiveProfile($event)"
                                    class="flex-1 bg-gray-50 dark:bg-[#0f1729] border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option *ngFor="let p of profiles" [value]="p.id">{{ p.name || 'Unnamed Profile' }}
                                    </option>
                                </select>
                                <button (click)="addNewProfile()"
                                    class="px-3 py-2 rounded-lg text-xs font-bold border border-blue-200 dark:border-blue-700 text-blue-600 dark:text-blue-200 hover:bg-blue-50 dark:hover:bg-blue-900/20">New</button>
                                <button (click)="saveActiveProfile()"
                                    class="px-3 py-2 rounded-lg text-xs font-bold bg-blue-600 text-white hover:bg-blue-700">Save</button>
                            </div>
                        </div>
                        <div class="p-4">
                            <p class="text-xs font-semibold text-blue-500 uppercase tracking-wide mb-2">Theme</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button *ngFor="let mode of modes"
                                    (click)="setTheme(mode.value); showProfileMenu = false"
                                    class="flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-400 dark:hover:border-blue-500 text-sm font-semibold text-gray-700 dark:text-gray-200">
                                    <span class="material-icons text-base">{{ mode.icon }}</span>
                                    <span>{{ mode.label }}</span>
                                    <span *ngIf="(currentTheme$ | async) === mode.value"
                                        class="ml-auto text-blue-500 text-xs font-bold">Active</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <app-sidebar (sidebarToggled)="onSidebarToggled($event)"></app-sidebar>

    <!-- Main Content with dynamic padding for sidebar -->
    <div [class]="'transition-all duration-500 ' + (isSidebarCollapsed ? 'ml-20' : 'ml-72')">
        <div class="container mx-auto px-6 py-8">
            <!-- Global KPI Ribbon -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-[#111827] rounded-2xl border border-slate-700/40 px-4 py-4 shadow-lg"
                    [class.skeleton]="kpiLoading">
                    <div class="flex flex-col">
                        <p class="text-2xl font-black text-white">
                            {{ kpiNetWorth | currency:'USD':'symbol':'1.0-0' }}
                        </p>
                        <div *ngIf="kpiNetWorthTrend" class="flex items-center gap-1.5 mt-1">
                            <span class="material-icons text-[14px]"
                                [class.text-emerald-400]="kpiNetWorthTrend.diff > 0"
                                [class.text-rose-400]="kpiNetWorthTrend.diff < 0">
                                {{ kpiNetWorthTrend.diff > 0 ? 'trending_up' : 'trending_down' }}
                            </span>
                            <span class="text-[11px] font-bold" [class.text-emerald-400]="kpiNetWorthTrend.diff > 0"
                                [class.text-rose-400]="kpiNetWorthTrend.diff < 0">
                                {{ kpiNetWorthTrend.diff > 0 ? '+' : '' }}{{ kpiNetWorthTrend.diff |
                                currency:'USD':'symbol':'1.0-0' }} ({{ kpiNetWorthTrend.percent | number:'1.1-1' }}%)
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">Net Assets − Core Debt</p>
                </div>
                <div class="bg-[#111827] rounded-2xl border border-slate-700/40 px-4 py-4 shadow-lg"
                    [class.skeleton]="kpiLoading">
                    <div class="flex flex-col">
                        <p class="text-2xl font-black text-rose-400">
                            {{ kpiTotalDebt | currency:'USD':'symbol':'1.0-0' }}
                        </p>
                        <div *ngIf="kpiDebtTrend && kpiDebtTrend.diff !== 0" class="flex items-center gap-1.5 mt-1">
                            <span class="material-icons text-[12px]" [class.text-emerald-400]="kpiDebtTrend.diff < 0"
                                [class.text-rose-400]="kpiDebtTrend.diff > 0">{{ kpiDebtTrend.diff > 0 ? 'arrow_upward'
                                : 'arrow_downward' }}</span>
                            <span class="text-[11px] font-bold" [class.text-emerald-400]="kpiDebtTrend.diff < 0"
                                [class.text-rose-400]="kpiDebtTrend.diff > 0">
                                {{ kpiDebtTrend.diff > 0 ? '+' : '' }}{{ kpiDebtTrend.diff |
                                currency:'USD':'symbol':'1.0-0' }} ({{ kpiDebtTrend.percent | number:'1.1-1' }}%)
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">Snapshot total</p>
                </div>
                <div class="bg-[#111827] rounded-2xl border border-slate-700/40 px-4 py-4 shadow-lg"
                    [class.skeleton]="kpiLoading">
                    <div class="flex flex-col">
                        <p class="text-2xl font-black text-emerald-400">
                            {{ kpiRetirementAssets | currency:'USD':'symbol':'1.0-0' }}
                        </p>
                        <div *ngIf="kpiRetirementTrend && kpiRetirementTrend.diff !== 0"
                            class="flex items-center gap-1.5 mt-1">
                            <span class="material-icons text-[12px]"
                                [class.text-emerald-400]="kpiRetirementTrend.diff > 0"
                                [class.text-rose-400]="kpiRetirementTrend.diff < 0">{{ kpiRetirementTrend.diff > 0 ?
                                'arrow_upward' : 'arrow_downward' }}</span>
                            <span class="text-[11px] font-bold" [class.text-emerald-400]="kpiRetirementTrend.diff > 0"
                                [class.text-rose-400]="kpiRetirementTrend.diff < 0">
                                {{ kpiRetirementTrend.diff > 0 ? '+' : '' }}{{ kpiRetirementTrend.diff |
                                currency:'USD':'symbol':'1.0-0' }} ({{ kpiRetirementTrend.percent | number:'1.1-1' }}%)
                            </span>
                            <span class="text-[10px] text-slate-400">vs last month</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">Selected snapshot</p>
                </div>
                <div class="bg-[#111827] rounded-2xl border border-slate-700/40 px-4 py-4 shadow-lg"
                    [class.skeleton]="kpiLoading">
                    <p class="text-xs uppercase tracking-wider text-slate-400">Savings Rate</p>
                    <p class="text-2xl font-black" [class.text-emerald-400]="(kpiSavingsRate ?? 0) >= 0"
                        [class.text-rose-400]="(kpiSavingsRate ?? 0) < 0">
                        {{ kpiSavingsRate !== null ? (kpiSavingsRate | number:'1.0-0') + '%' : '—' }}
                    </p>
                    <p class="text-xs text-slate-500">Budget {{ kpiMonthlyBudget | currency:'USD':'symbol':'1.0-0' }}
                        • Spent {{ kpiMonthlySpend | currency:'USD':'symbol':'1.0-0' }}</p>
                </div>
            </div>

            <!-- Debt Overview Section -->
            <div id="overview" class="scroll-mt-24">
                <app-debt-overview></app-debt-overview>
            </div>

            <!-- Strategy Command Center Section -->
            <div id="strategy" class="scroll-mt-24 mt-8">
                <app-strategy-dashboard></app-strategy-dashboard>
            </div>

            <!-- Progress Tracker Section -->
            <div id="progress" class="scroll-mt-24 mt-8">
                <app-progress-tracker></app-progress-tracker>
            </div>



            <!-- Debt Accounts Section -->
            <div id="accounts" class="scroll-mt-24 mt-8">
                <div class="mb-8">
                    <app-debt-accounts-list></app-debt-accounts-list>
                </div>
            </div>

            <!-- Budget Tracker Section -->
            <div id="budget" class="scroll-mt-24 mt-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-900 dark:text-white mb-6">Budget & Expenses</h2>
                    <app-budget-tracker></app-budget-tracker>
                </div>
            </div>

            <!-- Recurring Expenses Section -->
            <div id="recurring" class="scroll-mt-24 mt-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-black text-gray-900 dark:text-white mb-6">Recurring Expenses & EMIs</h2>
                    <app-recurring-expenses></app-recurring-expenses>
                </div>
            </div>

            <!-- Retirement Planning Section -->
            <div id="retirement" class="scroll-mt-24 mt-8">
                <div class="mb-8">
                    <app-retirement-tracker [profileAge]="activeProfile.age"
                        [profileRetirementAge]="activeProfile.retirementAge"></app-retirement-tracker>
                </div>
            </div>
        </div>
    </div>

    <app-toast></app-toast>

    <div class="fixed bottom-6 right-6 z-50">
        <button type="button" (click)="toggleQuickAddMenu()"
            class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex items-center justify-center">
            <span class="material-icons">{{ showQuickAddMenu ? 'close' : 'add' }}</span>
        </button>
        <div *ngIf="showQuickAddMenu"
            class="absolute bottom-14 right-0 w-44 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden">
            <button type="button" (click)="quickAddScroll('accounts')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800">
                Add Debt Account
            </button>
            <button type="button" (click)="quickAddScroll('budget')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800">
                Add Expense
            </button>
            <button type="button" (click)="quickAddScroll('retirement')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800">
                Update Retirement
            </button>
        </div>
    </div>
</div>
