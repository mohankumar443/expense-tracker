<div
    [class]="'fixed left-0 top-0 h-screen backdrop-blur-xl bg-white/95 dark:bg-[#111827] shadow-2xl transition-all duration-300 ease-in-out z-[60] border-r border-gray-200/60 dark:border-slate-600/60 ring-1 ring-black/5 dark:ring-white/5 ' + (isCollapsed ? 'w-20' : 'w-72')">
    <div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-purple-500/5 to-pink-500/5 pointer-events-none">
    </div>

    <!-- Toggle Button -->
    <button (click)="toggleSidebar()" title="{{ isCollapsed ? 'Expand sidebar' : 'Collapse sidebar' }}"
        class="absolute -right-3 top-6 bg-gradient-to-br from-primary to-purple-600 text-white rounded-full p-2 shadow-xl hover:shadow-2xl hover:scale-110 transition-all duration-300 z-50 ring-4 ring-white dark:ring-gray-900">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path *ngIf="isCollapsed" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5l7 7-7 7" />
            <path *ngIf="!isCollapsed" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 19l-7-7 7-7" />
        </svg>
    </button>

    <div [class]="'h-full overflow-y-auto pt-24 ' + (isCollapsed ? 'px-2 pb-4' : 'px-4 pb-5')">
        <!-- Brand -->
        <div class="mb-5 flex items-center gap-3" *ngIf="!isCollapsed">
            <div
                class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center shadow-lg">
                <span class="material-icons text-white text-lg">blur_on</span>
            </div>
            <div>
                <h3 class="font-black text-sm text-gray-900 dark:text-white">Modus</h3>
                <p class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">Analyze •
                    Optimize • Build • Freedom</p>
            </div>
        </div>


        <!-- Navigation -->
        <nav class="space-y-5">
            <div>
                <button (click)="toggleCore()" [title]="showCore ? 'Hide Core' : 'Show Core'"
                    [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                    (showCore ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                    <span class="material-icons text-[18px]">layers</span>
                    <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                        <span class="text-[10px] font-bold uppercase tracking-widest">Core</span>
                        <span
                            class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-400">
                            {{ totalCoreCount }}
                        </span>
                    </span>
                    <span *ngIf="!isCollapsed" class="material-icons text-base ml-auto">
                        {{ showCore ? 'expand_less' : 'expand_more' }}
                    </span>
                </button>
                <div *ngIf="showCore" class="space-y-2 mt-2">
                    <ng-container *ngFor="let item of coreNavItems">
                        <button (click)="setActiveSection(item.id)" [title]="item.label" [attr.aria-label]="item.label"
                            [class]="'relative group w-full flex items-center rounded-xl transition-all duration-200 ' +
                            (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                            (activeSection === item.id ? ' bg-blue-500/15 text-blue-500' :
                            ' text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                            <span *ngIf="activeSection === item.id"
                                class="absolute left-0 top-0 h-full w-1 rounded-r-full bg-blue-500"></span>
                            <span class="material-icons text-[18px]">{{ item.icon }}</span>
                            <span *ngIf="!isCollapsed" class="flex flex-col text-left">
                                <span class="font-semibold text-sm">{{ item.label }}</span>
                                <span *ngIf="item.hint" class="text-[10px] text-gray-400">
                                    {{ item.hint }}
                                </span>
                            </span>
                        </button>
                    </ng-container>
                </div>
            </div>

            <div>
                <button (click)="toggleAnalyze()" [title]="showAnalyze ? 'Hide Analyze' : 'Show Analyze'"
                    [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                    (showAnalyze ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                    <span class="material-icons text-[18px]">insights</span>
                    <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                        <span class="text-[10px] font-bold uppercase tracking-widest">Analyze</span>
                        <span
                            class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-400">
                            {{ totalAnalyzeCount }}
                        </span>
                    </span>
                    <span *ngIf="!isCollapsed" class="material-icons text-base ml-auto">
                        {{ showAnalyze ? 'expand_less' : 'expand_more' }}
                    </span>
                </button>
                <div *ngIf="showAnalyze" class="space-y-2 mt-2">
                    <ng-container *ngFor="let item of analyzeNavItems">
                        <button (click)="setActiveSection(item.id)" [title]="item.label" [attr.aria-label]="item.label"
                            [class]="'relative group w-full flex items-center rounded-xl transition-all duration-200 ' +
                            (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                            ((item.type === 'compare' && compareActive) ? ' bg-blue-500/15 text-blue-500' :
                            (activeSection === item.id ? ' bg-blue-500/15 text-blue-500' :
                            ' text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60'))">
                            <span *ngIf="(item.type === 'compare' && compareActive) || activeSection === item.id"
                                class="absolute left-0 top-0 h-full w-1 rounded-r-full bg-blue-500"></span>
                            <span class="material-icons text-[18px]">{{ item.icon }}</span>
                            <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                                <span class="font-semibold text-sm">{{ item.label }}</span>
                                <span *ngIf="item.type === 'compare' && compareActive"
                                    class="ml-2 text-[10px] font-bold text-blue-500">● Active</span>
                            </span>
                        </button>
                    </ng-container>
                </div>
            </div>

            <div>
                <button (click)="toggleDebt()" [title]="showDebt ? 'Hide Debt' : 'Show Debt'"
                    [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                    (showDebt ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                    <span class="material-icons text-[18px]">credit_card</span>
                    <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                        <span class="text-[10px] font-bold uppercase tracking-widest">Debt</span>
                        <span
                            class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-400">
                            {{ totalDebtCount }}
                        </span>
                    </span>
                    <span *ngIf="!isCollapsed" class="material-icons text-base ml-auto">
                        {{ showDebt ? 'expand_less' : 'expand_more' }}
                    </span>
                </button>
                <div *ngIf="showDebt" class="space-y-2 mt-2">
                    <ng-container *ngFor="let item of debtNavItems">
                        <button (click)="setActiveSection(item.id)" [title]="item.label" [attr.aria-label]="item.label"
                            [class]="'relative group w-full flex items-center rounded-xl transition-all duration-200 ' +
                            (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                            (activeSection === item.id ? ' bg-blue-500/15 text-blue-500' :
                            ' text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                            <span *ngIf="activeSection === item.id"
                                class="absolute left-0 top-0 h-full w-1 rounded-r-full bg-blue-500"></span>
                            <span class="material-icons text-[18px]">{{ item.icon }}</span>
                            <span *ngIf="!isCollapsed" class="font-semibold text-sm">{{ item.label }}</span>
                        </button>
                    </ng-container>
                </div>
            </div>

            <div>
                <button (click)="toggleWealth()" [title]="showWealth ? 'Hide Wealth' : 'Show Wealth'"
                    [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                    (showWealth ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                    <span class="material-icons text-[18px]">show_chart</span>
                    <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                        <span class="text-[10px] font-bold uppercase tracking-widest">Wealth</span>
                        <span
                            class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-400">
                            {{ totalWealthCount }}
                        </span>
                    </span>
                    <span *ngIf="!isCollapsed" class="material-icons text-base ml-auto">
                        {{ showWealth ? 'expand_less' : 'expand_more' }}
                    </span>
                </button>
                <div *ngIf="showWealth" class="space-y-2 mt-2">
                    <ng-container *ngFor="let item of wealthNavItems">
                        <button (click)="setActiveSection(item.id)" [title]="item.label" [attr.aria-label]="item.label"
                            [class]="'relative group w-full flex items-center rounded-xl transition-all duration-200 ' +
                            (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                            (activeSection === item.id ? ' bg-blue-500/15 text-blue-500' :
                            ' text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                            <span *ngIf="activeSection === item.id"
                                class="absolute left-0 top-0 h-full w-1 rounded-r-full bg-blue-500"></span>
                            <span class="material-icons text-[18px]">{{ item.icon }}</span>
                            <span *ngIf="!isCollapsed" class="font-semibold text-sm">{{ item.label }}</span>
                        </button>
                    </ng-container>
                </div>
            </div>

            <div>
                <button (click)="toggleStrategy()" [title]="showStrategy ? 'Hide Strategy' : 'Show Strategy'"
                    [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                    (showStrategy ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                    <span class="material-icons text-[18px]">track_changes</span>
                    <span *ngIf="!isCollapsed" class="flex items-center justify-between w-full">
                        <span class="text-[10px] font-bold uppercase tracking-widest">Strategy</span>
                        <span
                            class="px-2 py-0.5 rounded-full bg-gray-200 dark:bg-gray-700 text-[10px] font-bold text-gray-600 dark:text-gray-400">
                            {{ totalStrategyCount }}
                        </span>
                    </span>
                    <span *ngIf="!isCollapsed" class="material-icons text-base ml-auto">
                        {{ showStrategy ? 'expand_less' : 'expand_more' }}
                    </span>
                </button>
                <div *ngIf="showStrategy" class="space-y-2 mt-2">
                    <ng-container *ngFor="let item of strategyNavItems">
                        <button (click)="setActiveSection(item.id)" [title]="item.label" [attr.aria-label]="item.label"
                            [class]="'relative group w-full flex items-center rounded-xl transition-all duration-200 ' +
                            (isCollapsed ? 'justify-center p-3' : 'gap-3 px-3 py-2.5') +
                            (activeSection === item.id ? ' bg-blue-500/15 text-blue-500' :
                            ' text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                            <span *ngIf="activeSection === item.id"
                                class="absolute left-0 top-0 h-full w-1 rounded-r-full bg-blue-500"></span>
                            <span class="material-icons text-[18px]">{{ item.icon }}</span>
                            <span *ngIf="!isCollapsed" class="font-semibold text-sm">{{ item.label }}</span>
                        </button>
                    </ng-container>
                </div>
            </div>
        </nav>

        <!-- History -->
        <div *ngIf="!isCollapsed" class="mt-6">
            <button (click)="toggleHistory()" [title]="showHistory ? 'Hide History' : 'Show History'" [class]="'group w-full flex items-center rounded-xl transition-all duration-200 ' +
                    (showHistory ? ' bg-gray-100 dark:bg-gray-800/70 text-gray-900 dark:text-gray-100' :
                    ' text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800/60')">
                <span class="material-icons text-[18px]">history</span>
                <span class="flex items-center justify-between w-full px-3 py-2.5">
                    <span class="text-[10px] font-bold uppercase tracking-widest">History</span>
                    <span class="text-[10px] font-bold text-gray-400"> </span>
                </span>
                <span class="material-icons text-base ml-auto">
                    {{ showHistory ? 'expand_less' : 'expand_more' }}
                </span>
            </button>

            <div *ngIf="showHistory" class="mt-3">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-xs font-black text-gray-500 dark:text-gray-400 uppercase tracking-wider">Snapshots</p>
                    <button (click)="loadSnapshots()"
                        class="text-xs text-gray-400 hover:text-primary transition-colors">Refresh</button>
                </div>
                <div class="space-y-2">
                    <div *ngFor="let year of years">
                        <button (click)="toggleYear(year)"
                            class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <span>{{ year }}</span>
                            <span class="material-icons text-sm">
                                {{ expandedYears[year] ? 'expand_less' : 'expand_more' }}
                            </span>
                        </button>
                        <div *ngIf="expandedYears[year]"
                            class="mt-1 ml-2 space-y-1 border-l border-gray-200 dark:border-gray-700 pl-2">
                            <div *ngFor="let snapshot of groupedSnapshots[year]" class="flex items-center group">
                                <button (click)="selectSnapshot(snapshot)"
                                    class="flex-1 flex items-center px-2 py-1.5 rounded-lg text-xs text-gray-500 dark:text-gray-400 hover:text-primary hover:bg-primary/5 transition-colors">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-gray-300 group-hover:bg-primary mr-2"></span>
                                    {{ getMonthName(snapshot.snapshotDate) }}
                                </button>
                                <button (click)="deleteSnapshot(snapshot); $event.stopPropagation()"
                                    class="opacity-0 group-hover:opacity-100 p-1 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-all"
                                    title="Delete this snapshot">
                                    <span class="material-icons text-sm">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirmation" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" (click)="cancelDelete()"></div>
    <div
        class="relative bg-white dark:bg-[#1a2332] rounded-2xl shadow-xl w-full max-w-sm overflow-hidden animate-fade-in-up border border-gray-200 dark:border-gray-700">
        <div class="p-6 text-center">
            <div
                class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-icons text-3xl">warning</span>
            </div>
            <h3 class="text-xl font-black text-gray-900 dark:text-white mb-2">Delete Snapshot?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">{{ deleteConfirmationMessage }}</p>
            <div class="flex gap-3">
                <button (click)="cancelDelete()"
                    class="flex-1 px-4 py-2.5 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                <button (click)="confirmDelete()"
                    class="flex-1 px-4 py-2.5 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-colors shadow-lg shadow-red-500/20">Delete</button>
            </div>
        </div>
    </div>
</div>
